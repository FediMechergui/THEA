pipeline {
    agent any
    
    environment {
        // Service Configuration
        SERVICE_NAME = 'rag-chatbot'
        IMAGE_NAME = 'thea-rag-chatbot'
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        
        // Application Environment
        PYTHON_ENV = 'production'
        
        // Docker Configuration (Local)
        DOCKER_BUILDKIT = '1'
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 60, unit: 'MINUTES')  // Increased timeout for heavy ML dependencies
        timestamps()
    }
    
    stages {
        stage('Checkout & Environment Setup') {
            steps {
                echo "üöÄ Starting RAG Chatbot Service CI/CD Pipeline - Build #${env.BUILD_NUMBER}"
                
                script {
                    // Display build information
                    sh '''
                        echo "=== Build Information ==="
                        echo "Branch: ${GIT_BRANCH}"
                        echo "Build Number: ${BUILD_NUMBER}"
                        echo "Python Version: $(python3 --version)"
                        echo "Docker Version: $(docker --version)"
                        echo "=========================="
                    '''
                }
            }
        }
        
        stage('Install Dependencies') {
            steps {
                echo "üì¶ Installing Python dependencies (this may take a while for ML packages)"
                
                dir('rag_chatbot') {
                    sh '''
                        # Create virtual environment
                        python3 -m venv venv || true
                        
                        # Activate and install dependencies
                        . venv/bin/activate
                        pip install --upgrade pip
                        
                        # Install dependencies with timeout
                        pip install --default-timeout=300 -r requirements.txt || true
                        
                        # List installed packages
                        pip list > dependency-report.txt
                    '''
                }
                
                // Archive dependency report
                archiveArtifacts artifacts: 'rag_chatbot/dependency-report.txt', fingerprint: true
            }
        }
        
        stage('Code Quality Checks') {
            steps {
                echo "üîç Running code quality checks"
                
                dir('rag_chatbot') {
                    sh '''
                        . venv/bin/activate
                        
                        # Run pylint if available
                        pip install pylint || true
                        pylint app/ --output-format=text || true
                        
                        # Run flake8 if available
                        pip install flake8 || true
                        flake8 app/ --max-line-length=120 || true
                    '''
                }
            }
        }
        
        stage('Run Tests') {
            steps {
                echo "üß™ Running RAG Chatbot tests"
                
                dir('rag_chatbot') {
                    sh '''
                        . venv/bin/activate
                        
                        # Run pytest if test files exist
                        if [ -d "tests" ]; then
                            pip install pytest pytest-cov || true
                            pytest tests/ --verbose --cov=app || true
                        else
                            echo "No test directory found, skipping tests"
                        fi
                    '''
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                echo "üê≥ Building Docker image for RAG Chatbot (this may take 15-20 minutes)"
                
                dir('rag_chatbot') {
                    script {
                        // Build Docker image with increased timeout
                        sh """
                            docker build \
                                --build-arg BUILD_DATE=\$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
                                --build-arg BUILD_VERSION=${IMAGE_TAG} \
                                --network=host \
                                -t ${IMAGE_NAME}:${IMAGE_TAG} \
                                -t ${IMAGE_NAME}:latest \
                                .
                        """
                        
                        // Show image info
                        sh "docker images | grep ${IMAGE_NAME}"
                    }
                }
            }
        }
        
        stage('Security Scan') {
            steps {
                echo "üîí Running security scan on Docker image"
                
                script {
                    // Install trivy if not present
                    sh '''
                        if ! command -v trivy &> /dev/null; then
                            echo "Trivy not installed, skipping security scan"
                        else
                            trivy image --severity HIGH,CRITICAL ${IMAGE_NAME}:${IMAGE_TAG} || true
                        fi
                    '''
                }
            }
        }
        
        stage('Check Prerequisites') {
            steps {
                echo "üîç Checking required services (Ollama, ChromaDB, PostgreSQL)"
                
                script {
                    sh '''
                        # Check if required services are running
                        echo "Checking Ollama..."
                        curl -f http://localhost:11434/api/version || echo "‚ö†Ô∏è  Ollama not running"
                        
                        echo "Checking ChromaDB..."
                        curl -f http://localhost:8010/api/v1/heartbeat || echo "‚ö†Ô∏è  ChromaDB not running"
                        
                        echo "Checking PostgreSQL..."
                        docker ps | grep postgres || echo "‚ö†Ô∏è  PostgreSQL not running"
                    '''
                }
            }
        }
        
        stage('Deploy Locally') {
            steps {
                echo "üöÄ Deploying RAG Chatbot service locally"
                
                script {
                    sh '''
                        # Stop existing containers if running
                        docker stop thea-rag-chatbot || true
                        docker rm thea-rag-chatbot || true
                        
                        docker stop thea-rag-chatbot-worker || true
                        docker rm thea-rag-chatbot-worker || true
                        
                        # Run new container
                        docker run -d \
                            --name thea-rag-chatbot \
                            --network thea-network \
                            -p 8001:8001 \
                            -v $(pwd)/rag_chatbot/data:/app/data \
                            --env-file rag_chatbot/.env.docker \
                            ${IMAGE_NAME}:${IMAGE_TAG}
                        
                        # Run worker container
                        docker run -d \
                            --name thea-rag-chatbot-worker \
                            --network thea-network \
                            -v $(pwd)/rag_chatbot/data:/app/data \
                            --env-file rag_chatbot/.env.docker \
                            ${IMAGE_NAME}:${IMAGE_TAG} \
                            celery -A app.worker.celery worker --loglevel=info
                        
                        # Wait for service to be ready
                        echo "Waiting for RAG Chatbot to be ready..."
                        sleep 20
                        
                        # Health check
                        curl -f http://localhost:8001/health || exit 1
                    '''
                }
            }
        }
    }
    
    post {
        success {
            echo "‚úÖ RAG Chatbot Pipeline completed successfully!"
            
            // Clean up old images
            sh '''
                docker image prune -f --filter "until=168h" || true
            '''
        }
        
        failure {
            echo "‚ùå RAG Chatbot Pipeline failed!"
        }
        
        always {
            // Cleanup workspace
            cleanWs()
        }
    }
}
