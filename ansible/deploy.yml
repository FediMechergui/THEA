---
# THEA Backend Microservices Deployment Playbook
# This playbook deploys the complete THEA backend system

- name: Deploy THEA Backend Microservices
  hosts: all
  become: yes
  gather_facts: yes
  vars_files:
    - vars/{{ env }}.yml
    - vars/secrets.yml
  pre_tasks:
    - name: Update package cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Install required packages
      package:
        name:
          - curl
          - wget
          - git
          - unzip
          - python3
          - python3-pip
          - docker.io
          - docker-compose
        state: present

    - name: Start and enable Docker service
      service:
        name: docker
        state: started
        enabled: yes

  roles:
    - role: common
    - role: docker
    - role: nodejs_backend
    - role: fastapi_ocr
    - role: rag_chatbot
    - role: monitoring
    - role: security
    - role: backup

  post_tasks:
    - name: Wait for services to be healthy
      uri:
        url: "http://localhost:3000/health"
        method: GET
        status_code: 200
      register: health_check
      until: health_check.status == 200
      retries: 30
      delay: 10
      ignore_errors: yes

    - name: Deployment summary
      debug:
        msg:
          - "ğŸ‰ THEA Backend deployment completed!"
          - "ğŸ“Š Services Status: {{ health_check.status | default('Unknown') }}"
          - "ğŸŒ Node.js Backend: http://{{ domain }}:3000"
          - "ğŸ¤– FastAPI OCR: http://{{ domain }}:8000"
          - "ğŸ’¬ RAG Chatbot: http://{{ domain }}:8001"
          - "ğŸ“ˆ Grafana: http://{{ domain }}:3010"
          - "ğŸ° RabbitMQ: http://{{ domain }}:15672"
          - "ğŸ“ MinIO: http://{{ domain }}:9000"

    - name: Create deployment marker
      file:
        path: /opt/thea/.deployed
        state: touch
        mode: '0644'